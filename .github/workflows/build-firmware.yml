name: Build Firmware

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  build:
    name: Build ${{ matrix.chip }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          # ESP32 (original)
          - target: xtensa-esp32-espidf
            chip: esp32

          # ESP32-C3 (RISC-V, USB serial)
          - target: riscv32imc-esp-espidf
            chip: esp32c3

          # ESP32-S2 (USB OTG)
          - target: xtensa-esp32s2-espidf
            chip: esp32s2

          # ESP32-S3 (dual core with USB OTG)
          - target: xtensa-esp32s3-espidf
            chip: esp32s3

          # ESP32-C2 (low cost RISC-V)
          - target: riscv32imc-esp-espidf
            chip: esp32c2

          # ESP32-C6 (WiFi 6, Zigbee, Thread)
          - target: riscv32imac-esp-espidf
            chip: esp32c6

          # ESP32-H2 (BLE 5, Zigbee, Thread)
          - target: riscv32imac-esp-espidf
            chip: esp32h2

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: stable
          components: rust-src

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y git wget flex bison gperf python3 python3-pip python3-venv \
            cmake ninja-build ccache libffi-dev libssl-dev dfu-util libusb-1.0-0

      - name: Setup Xtensa toolchain
        if: ${{ contains(matrix.target, 'xtensa') }}
        uses: esp-rs/xtensa-toolchain@v1.6
        with:
          default: true
          ldproxy: true

      - name: Setup RISC-V toolchain
        if: ${{ contains(matrix.target, 'riscv') }}
        run: |
          rustup target add ${{ matrix.target }}

      - name: Install espup and configure ESP-IDF
        run: |
          cargo install espup
          espup install
          . $HOME/export-esp.sh

      - name: Install espflash
        run: cargo install espflash

      - name: Update .cargo/config.toml
        working-directory: firmware/morse-blinker
        run: |
          sed -i 's/target = .*/target = "${{ matrix.target }}"/' .cargo/config.toml

      - name: Build firmware
        working-directory: firmware/morse-blinker
        run: |
          . $HOME/export-esp.sh
          cargo build --release --target ${{ matrix.target }}

      - name: Generate merged binary
        working-directory: firmware/morse-blinker
        run: |
          espflash save-image --chip ${{ matrix.chip }} --merge \
            target/${{ matrix.target }}/release/morse-blinker \
            morse-blinker-${{ matrix.chip }}.bin

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: morse-blinker-${{ matrix.chip }}
          path: firmware/morse-blinker/morse-blinker-${{ matrix.chip }}.bin
          retention-days: 90

  create-release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Display structure
        run: ls -R artifacts

      - name: Create release directory
        run: |
          mkdir -p release
          find artifacts -name "*.bin" -exec cp {} release/ \;
          ls -lh release/

      - name: Get version from Cargo.toml
        id: version
        working-directory: firmware/morse-blinker
        run: |
          VERSION=$(grep '^version = ' Cargo.toml | head -1 | sed 's/version = "\(.*\)"/\1/')
          echo "version=v$VERSION" >> $GITHUB_OUTPUT
          echo "Version: v$VERSION"

      - name: Get short SHA
        id: sha
        run: |
          SHORT_SHA=$(git rev-parse --short HEAD)
          echo "short_sha=$SHORT_SHA" >> $GITHUB_OUTPUT
          echo "Short SHA: $SHORT_SHA"

      - name: Create release tag
        id: tag
        run: |
          TAG="${{ steps.version.outputs.version }}-${{ steps.sha.outputs.short_sha }}"
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "Release tag: $TAG"

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          name: "Morse Blinker ${{ steps.tag.outputs.tag }}"
          body: |
            ## Morse Code Blinker Firmware

            Pre-built binaries for ESP32 targets.

            ### Supported Chips
            - ESP32 (original)
            - ESP32-C3 (RISC-V, USB serial)
            - ESP32-S2 (USB OTG)
            - ESP32-S3 (dual core, USB OTG)
            - ESP32-C2 (low cost)
            - ESP32-C6 (WiFi 6, Zigbee, Thread)
            - ESP32-H2 (BLE 5, Zigbee, Thread)

            ### How to Use

            **Option 1: Web Flasher (Recommended)**
            Visit https://adam-weber.github.io/esp-webflash-toolkit/flasher/?project=morse-code-blinker

            **Option 2: Manual Flash**
            ```bash
            espflash write-bin 0x0 morse-blinker-esp32.bin
            ```

            Built from commit: ${{ github.sha }}
          files: release/*.bin
          draft: false
          prerelease: false
          generate_release_notes: true
